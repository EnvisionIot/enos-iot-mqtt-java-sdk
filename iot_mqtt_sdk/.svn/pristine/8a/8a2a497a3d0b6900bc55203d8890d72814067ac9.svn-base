package com.envisioniot.enos.iot_mqtt_sdk.sample;

import java.util.List;

import com.envisioniot.enos.iot_mqtt_sdk.core.MqttClient;
import com.envisioniot.enos.iot_mqtt_sdk.core.exception.EnvisionException;
import com.envisioniot.enos.iot_mqtt_sdk.core.msg.IMessageHandler;
import com.envisioniot.enos.iot_mqtt_sdk.message.downstream.tsl.ServiceInvocationCommand;
import com.envisioniot.enos.iot_mqtt_sdk.message.downstream.tsl.ServiceInvocationReply;
import com.envisioniot.enos.iot_mqtt_sdk.message.upstream.register.DeviceRegOption;
import com.envisioniot.enos.iot_mqtt_sdk.message.upstream.register.SubDeviceDynamicRegMqttRequest;
import com.envisioniot.enos.iot_mqtt_sdk.message.upstream.register.SubDeviceDynamicRegResponse;
import com.envisioniot.enos.iot_mqtt_sdk.message.upstream.status.SubDeviceLoginInfo;
import com.envisioniot.enos.iot_mqtt_sdk.message.upstream.status.SubDeviceLoginMqttRequest;
import com.envisioniot.enos.iot_mqtt_sdk.message.upstream.status.SubDeviceLoginResponse;
import com.envisioniot.enos.iot_mqtt_sdk.message.upstream.status.SubDeviceLogoutMqttRequest;
import com.envisioniot.enos.iot_mqtt_sdk.message.upstream.status.SubDeviceLogoutResponse;
import com.envisioniot.enos.iot_mqtt_sdk.message.upstream.topo.AddTopoMqttRequest;
import com.envisioniot.enos.iot_mqtt_sdk.message.upstream.topo.AddTopoResponse;
import com.envisioniot.enos.iot_mqtt_sdk.message.upstream.topo.SubDeviceInfo;
import com.envisioniot.enos.iot_mqtt_sdk.message.upstream.tsl.EventPostRequest;
import com.envisioniot.enos.iot_mqtt_sdk.message.upstream.tsl.TslTemplateGetMqttRequest;
import com.envisioniot.enos.iot_mqtt_sdk.message.upstream.tsl.TslTemplateGetResponse;

/**
 * @author zhensheng.cai
 * @date 2018/8/3.
 */
public class SimpleSendReceive
{
	private static final String local = "tcp://localhost:11883";
	private static final String alpha = "tcp://10.24.10.56:11883";
	private static final String productKey = "8myRluG6";
	public static final String deviceKey = "zscai-test-device";
	public static final String deviceSecret = "KDZLIqVCn6rU11TKp8XO";

	public static final String subProductKey = "iM3Zf8uF";
	public static final String subDeviceKey = "zscai-sub-device";
	public static final String subDeviceSecret = "ZnH5DJvo3uE9c5fxoXug";


	private static MqttClient client;


	public static void init(){
		try
		{
			client= new MqttClient(alpha, productKey, deviceKey, deviceSecret);
			client.connect();
//			client.setTimeToWait(6000);
		}
		catch (EnvisionException e)
		{
			e.printStackTrace();
		}
		System.out.println("connect:" + client.isConnected());

	}

	public static void subDeviceRegister(){
		System.out.println("start register register sub-device , current status : "+client.isConnected());
		SubDeviceDynamicRegMqttRequest request = new SubDeviceDynamicRegMqttRequest();
		request.addRegOption(new DeviceRegOption("zscai-sub-device-1", "zscai-sub-device-1", "zscai-sub-device-1"));
		request.addRegOption(new DeviceRegOption("zscai-sub-device-2", "zscai-sub-device-2", "zscai-sub-device-2"));
		request.addRegOption(new DeviceRegOption("zscai-sub-device-3", "zscai-sub-device-3", "zscai-sub-device-3"));
		request.setRegProductKey(productKey);
		SubDeviceDynamicRegResponse rsp = null;
		try
		{
		    
			rsp = client.publish(request);
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}
		System.out.println("--->" + rsp);
	}

	/*
	if not gateway cannot add topo
	BaseMqttResponse{id='1', code=-32008, data=null, message='Not gateway', method='null'}
	 */
	public static void subDeviceAddTopo(){
		AddTopoMqttRequest request = new AddTopoMqttRequest();
		request.addSubDevice(new SubDeviceInfo(subProductKey, subDeviceKey, subDeviceSecret));
		try
		{
			AddTopoResponse rsp = client.publish(request);
			System.out.println(rsp);
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}

	}

	public static void subDeviceLogin(){
		System.out.println("start register login sub-device , current status : "+client.isConnected());
		SubDeviceLoginMqttRequest request = new SubDeviceLoginMqttRequest();
		request.setSubDeviceInfo(new SubDeviceLoginInfo(subProductKey , subDeviceKey, subDeviceSecret));
		SubDeviceLoginResponse rsp = null;

		try
		{
			rsp = client.publish(request);
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}
		System.out.println(rsp);
	}

	public static void subdeviceLogout(){
		SubDeviceLogoutMqttRequest request = new SubDeviceLogoutMqttRequest();
		request.setSubProductKey(subProductKey);
		request.setSubDeviceKey(subDeviceKey);
		SubDeviceLogoutResponse rsp = null;
		try
		{
			rsp = client.publish(request);
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}
		System.out.println(rsp);

		System.out.println("Assert sub device logout ,post subdevice event");
		postSubEvent();

	}







	/*

	BaseMqttResponse{id='1', code=200, data={tslModelId=xfgBHRXU, tslAttributeMap={}, tslMeasurepointMap={}, tslServiceMap={}, tslEventMap={}, tag={tagMap={}}, allowAdditionalAttribute=false, inheritedAttributeIds=[], inheritedMeasurepointIds=[], inheritedServiceIds=[], inheritedEventIds=[]}, message='null', method='null'}
	*/
	public static void getTslTemplete()
	{
		TslTemplateGetMqttRequest request = new TslTemplateGetMqttRequest();
		TslTemplateGetResponse rsp = null;
		try
		{
			rsp = client.publish(request);
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}
		System.out.println(rsp);
	}


	public static void postSubEvent(){
		System.out.println("start post");
		EventPostRequest postRequest = new EventPostRequest("PowerTooHigh");
		postRequest.setProductKey(subProductKey);
		postRequest.setDeviceKey(subDeviceKey);
		postRequest.addValue("PowerAlarm", 60);
		try
		{
			/**
			 * 当前版本Post消息没有对应的reply
			 */
			client.publish(postRequest);
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}
	}



	public  static void handleServiceInvocation()
	{
	    IMessageHandler<ServiceInvocationCommand, ServiceInvocationReply> handler = new IMessageHandler<ServiceInvocationCommand, ServiceInvocationReply>()
        {
            @Override
            public ServiceInvocationReply onMessage(ServiceInvocationCommand request, List<String> argList) throws Exception
            {
                System.out.println("rcvn async serevice invocation command" +  request + " topic ");
                ServiceInvocationReply reply = new ServiceInvocationReply(argList.get(0), argList.get(1), argList.get(2));
                reply.addOutputData("pointA" , "valueA");
                return reply;
            }
            
        };
        
        
        client.setArrivedMsgHandler(ServiceInvocationCommand.class, handler);
        
        //client.addCommandHandler(handler);

		//hold the thread
		while(true){
			try
			{
				Thread.sleep(1000);
			}
			catch (InterruptedException e)
			{
				e.printStackTrace();
			}
		}
	}



	public static void main(String[] args)
	{
		init();
	subDeviceRegister();
//		subDeviceAddTopo();
//		subDeviceLogin();
//		postSubEvent();
//		subdeviceLogout();
//		getTslTemplete();
		handleServiceInvocation();

	}


}
