package com.envisioniot.enos.iot_mqtt_sdk.core;

import java.util.concurrent.atomic.AtomicLong;

import com.envisioniot.enos.iot_mqtt_sdk.core.exception.EnvisionException;
import com.envisioniot.enos.iot_mqtt_sdk.core.internals.MqttConnection;
import com.envisioniot.enos.iot_mqtt_sdk.core.msg.IMessageHandler;
import com.envisioniot.enos.iot_mqtt_sdk.core.msg.IMqttArrivedMessage;
import com.envisioniot.enos.iot_mqtt_sdk.core.msg.IMqttRequest;
import com.envisioniot.enos.iot_mqtt_sdk.core.msg.IMqttResponse;
import com.envisioniot.enos.iot_mqtt_sdk.core.profile.Profile;
import com.envisioniot.enos.iot_mqtt_sdk.util.StringUtil;

/**
 *
 * @author zhensheng.cai
 * @date 2018/7/3.
 */
public class MqttClient
{
	// private static Logger logger = LoggerFactory.getLogger(MqttClient.class);
	private AtomicLong requestId = new AtomicLong(0);

	// private EnvClientProfile profile;
	// private EnvConnectOptions connOptions;
	// private final EnvMqttProcessor mqttProcessor;
	private final MqttConnection connection;
	private Profile profile;

	/**
	 *
	 * @param uri
	 * @param productKey
	 * @param deviceKey
	 * @param deviceSecret
	 * @throws EnvisionException
	 */
	public MqttClient(String uri, String productKey, String deviceKey, String deviceSecret)
	{
		profile = new Profile(uri, productKey, deviceKey, deviceSecret);
		connection = new MqttConnection(profile);
	}

	public <T extends IMqttResponse> void fastPublish(IMqttRequest<T> request) throws Exception
	{
		publish(request, null);
	}

	public <T extends IMqttResponse> T publish(IMqttRequest<T> request) throws Exception
	{
		// 1. do register IMessageCallback
		fillRequest(request);
		request.check();

		// 2. do post
		return connection.publish(request);
	}

	public <T extends IMqttResponse> void publish(IMqttRequest<T> request, IResponseCallback<T> callback)
			throws Exception
	{
		this.fillRequest(request);
		request.check();

		connection.publish(request, callback);
	}

	public void setArrivedMsgHandler(Class<? extends IMqttArrivedMessage> arrivedMsgCls, IMessageHandler<?, ?> handler)
	{
		connection.getProcessor().setArrivedMsgHandler(arrivedMsgCls, handler);
	}

	// TODO 开放回到给用户，让用户去管理子设备的上线状态
	public void connect() throws EnvisionException
	{
		connection.connect();
	}

	public void disconnect() throws EnvisionException
	{
		this.connection.disconnect();
	}

	public void close() throws EnvisionException
	{
		this.connection.close();
	}

	public boolean isConnected()
	{
		return this.connection.isConnected();
	}

	private void fillRequest(IMqttRequest<?> request)
	{
		if (StringUtil.isEmpty(request.getMessageId()))
		{
			request.setMessageId(String.valueOf(requestId.incrementAndGet()));
		}

		if (StringUtil.isEmpty(request.getVersion()))
		{
			request.setVersion(Profile.VERSION);
		}

		if (StringUtil.isEmpty(request.getProductKey()) && StringUtil.isEmpty(request.getDeviceKey()))
		{
			request.setProductKey(profile.getProductKey());
			request.setDeviceKey(profile.getDeviceKey());
		}
	}

}
